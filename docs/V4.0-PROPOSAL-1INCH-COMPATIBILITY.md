# V4.0 Proposal: Full 1inch Compatibility and Critical Fixes

## Executive Summary

After comprehensive analysis of our bmn-evm-contracts against the production 1inch cross-chain-swap repository (which handles millions of dollars in transactions), we have identified **10 critical incompatibilities** and **3 major architectural issues** that prevent our system from being truly 1inch-compatible. This proposal outlines the necessary changes for v4.0 to achieve full compatibility while maintaining our simplified non-whitelisted atomic swap goals.

## Current State Assessment

### What We Have (bmn-evm-contracts)
- **SimplifiedEscrowFactory**: Standalone factory with basic postInteraction support
- **Simplified Whitelist**: Basic resolver whitelist without inheritance
- **No Fee Structure**: Empty parameters field, no fee handling
- **Basic Timelocks**: Incorrect packing in postInteraction causing test failures
- **Factory Validation Issue**: CREATE3 deployment causes FACTORY immutable to be incorrect

### What 1inch Has (cross-chain-swap)
- **EscrowFactory**: Inherits from SimpleSettlement and MerkleStorageInvalidator
- **Access Token System**: Uses 1inch token for public function access
- **Complete Fee Structure**: Integrator fees, protocol fees, resolver fees with configurable rates
- **Partial Fill Support**: Merkle tree validation for multi-part orders
- **Proper Timelock Handling**: Correct timestamp tolerance and validation

## Critical Incompatibilities

### 1. Missing SimpleSettlement Inheritance ❌ CRITICAL
**Location**: `contracts/SimplifiedEscrowFactory.sol:20`
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:31`

Our factory doesn't inherit from SimpleSettlement, missing critical 1inch infrastructure:
```solidity
// CURRENT (BROKEN)
contract SimplifiedEscrowFactory is IPostInteraction {

// REQUIRED
contract SimplifiedEscrowFactory is SimpleSettlement, MerkleStorageInvalidator {
```

**Impact**: Cannot integrate with 1inch limit order protocol properly
**Fix Required**: Yes - Must inherit and implement SimpleSettlement

### 2. Incorrect postInteraction Signature ❌ CRITICAL
**Location**: `contracts/SimplifiedEscrowFactory.sol:205-214`
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:65-74`

Our postInteraction is public, but should be internal _postInteraction:
```solidity
// CURRENT (WRONG)
function postInteraction(...) external override whenNotPaused {

// REQUIRED
function _postInteraction(...) internal override(FeeTaker) {
```

**Impact**: External callers can bypass 1inch protocol flow
**Fix Required**: Yes - Must use internal _postInteraction pattern

### 3. Missing Fee Structure ❌ CRITICAL
**Location**: `contracts/SimplifiedEscrowFactory.sol:268` (empty parameters)
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:141-146`

We have no fee handling:
```solidity
// CURRENT (BROKEN)
parameters: ""  // Empty for BMN

// REQUIRED
parameters: abi.encode(
    protocolFeeAmount,
    integratorFeeAmount,
    Address.wrap(uint160(protocolFeeRecipient)),
    Address.wrap(uint160(integratorFeeRecipient))
)
```

**Impact**: Cannot collect fees, breaking business model
**Fix Required**: Yes - Must implement FeeTaker pattern

### 4. No Partial Fill Support ❌ MAJOR
**Location**: Missing MerkleStorageInvalidator
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:110-121`

Cannot handle multi-part orders:
```solidity
// MISSING
if (MakerTraitsLib.allowMultipleFills(order.makerTraits)) {
    // Merkle validation for partial fills
}
```

**Impact**: Cannot support partial order fills
**Fix Required**: Yes for full compatibility

### 5. Incorrect Timelock Packing ❌ CRITICAL
**Location**: `contracts/SimplifiedEscrowFactory.sol:245-255`
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:131`

Setting deployedAt incorrectly:
```solidity
// CURRENT (BROKEN)
uint256 packedTimelocks = uint256(uint32(block.timestamp)) << 224; // WRONG!

// REQUIRED
timelocks: extraDataArgs.timelocks.setDeployedAt(block.timestamp)
```

**Impact**: All E2E tests fail with InvalidTime()
**Fix Required**: Yes - Critical for functionality

### 6. Factory Address Validation Bug ❌ CRITICAL
**Location**: `docs/FACTORY_IMMUTABLE_BUG_ANALYSIS.md`
**Issue**: When deployed via CREATE3, FACTORY immutable captures wrong address

Current deployment flow causes validation failures:
```solidity
// BaseEscrow.sol:31
address public immutable FACTORY = msg.sender; // Gets CREATE3 factory, not our factory!
```

**Impact**: All escrow operations fail with InvalidImmutables()
**Fix Required**: Yes - Use v2.3 solution (factory deploys implementations)

### 7. Missing ExtraData Chain Support ❌ MINOR
**Location**: `contracts/SimplifiedEscrowFactory.sol:298`
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:90-101`

No support for chaining extra postInteractions:
```solidity
// MISSING
if (tail.length > 19) {
    IPostInteraction(address(bytes20(tail))).postInteraction(...);
}
```

**Impact**: Cannot chain multiple postInteractions
**Fix Required**: Optional but recommended

### 8. Different Access Control Model ⚠️ DESIGN CHOICE
**Location**: Our EIP-712 signatures vs 1inch ACCESS_TOKEN
**1inch**: Uses 1INCH token balance for public functions

We use resolver signatures, they use token holdings:
```solidity
// OURS
_requireValidResolverSig(orderHash, "publicWithdraw", signature);

// 1INCH
if (_ACCESS_TOKEN.balanceOf(msg.sender) == 0) revert InvalidCaller();
```

**Impact**: Different UX, may confuse integrators
**Fix Required**: Consider alignment

### 9. Missing Timestamp Tolerance ⚠️ MINOR
**Location**: Not implemented
**1inch**: `cross-chain-swap/contracts/BaseEscrowFactory.sol:172`

Should have 5-minute tolerance for chain timestamp drift:
```solidity
// MISSING
uint256 constant TIMESTAMP_TOLERANCE = 300; // 5 minutes
```

**Impact**: May cause issues with chain timestamp differences
**Fix Required**: Recommended

### 10. Incorrect Event Structure ❌ MINOR
**Location**: `contracts/SimplifiedEscrowFactory.sol:76-82`
**1inch**: Different event signatures

Our events don't match 1inch format exactly, breaking indexers.

## Proposed V4.0 Architecture

### Phase 1: Critical Fixes (MUST HAVE)
1. **Fix Factory Deployment**: Implement v2.3 solution
2. **Fix postInteraction**: Make internal, inherit SimpleSettlement
3. **Fix Timelocks**: Use setDeployedAt properly
4. **Add Fee Structure**: Implement FeeTaker

### Phase 2: Full Compatibility (SHOULD HAVE)
5. **Add Partial Fills**: Implement MerkleStorageInvalidator
6. **Add ExtraData Chaining**: Support nested postInteractions
7. **Add Timestamp Tolerance**: Handle chain drift
8. **Align Events**: Match 1inch signatures

### Phase 3: Optional Enhancements (NICE TO HAVE)
9. **Consider Access Token**: Evaluate switching from signatures
10. **Add Metrics**: Implement analytics

## Implementation Plan

### Step 1: Create V4 Factory Contract
```solidity
// contracts/EscrowFactoryV4.sol
contract EscrowFactoryV4 is SimpleSettlement, MerkleStorageInvalidator {
    constructor(
        address limitOrderProtocol,
        IERC20 accessToken,
        address owner,
        uint32 rescueDelay
    ) SimpleSettlement(limitOrderProtocol, accessToken, address(0), owner)
      MerkleStorageInvalidator(limitOrderProtocol) {
        // Deploy implementations in constructor (v2.3 pattern)
        ESCROW_SRC_IMPLEMENTATION = address(new EscrowSrc(rescueDelay, accessToken));
        ESCROW_DST_IMPLEMENTATION = address(new EscrowDst(rescueDelay, accessToken));
        _PROXY_SRC_BYTECODE_HASH = ProxyHashLib.computeProxyBytecodeHash(ESCROW_SRC_IMPLEMENTATION);
        _PROXY_DST_BYTECODE_HASH = ProxyHashLib.computeProxyBytecodeHash(ESCROW_DST_IMPLEMENTATION);
    }
    
    function _postInteraction(
        IOrderMixin.Order calldata order,
        bytes calldata extension,
        bytes32 orderHash,
        address taker,
        uint256 makingAmount,
        uint256 takingAmount,
        uint256 remainingMakingAmount,
        bytes calldata extraData
    ) internal override(FeeTaker) {
        // Proper 1inch-compatible implementation
    }
}
```

### Step 2: Fix Timelocks Library Usage
```solidity
// In _postInteraction
immutables.timelocks = extraDataArgs.timelocks.setDeployedAt(block.timestamp);
// NOT: uint256 packedTimelocks = uint256(uint32(block.timestamp)) << 224;
```

### Step 3: Implement Fee Structure
```solidity
// Extract fees from extraData
(uint256 integratorFeeAmount, uint256 protocolFeeAmount, bytes calldata tail) = 
    FeeTaker._getFeeAmounts(order, taker, takingAmount, makingAmount, extraData[:superArgsLength]);

// Pack into parameters
parameters: abi.encode(
    protocolFeeAmount,
    integratorFeeAmount,
    protocolFeeRecipient,
    integratorFeeRecipient
)
```

### Step 4: Add Partial Fill Support
```solidity
if (MakerTraitsLib.allowMultipleFills(order.makerTraits)) {
    uint256 partsAmount = uint256(extraDataArgs.hashlockInfo) >> 240;
    if (partsAmount < 2) revert InvalidSecretsAmount();
    // Merkle validation logic
}
```

## Migration Path

### For Existing Deployments
1. **Cannot Upgrade**: Existing v3.x deployments are broken due to factory bug
2. **Must Redeploy**: Deploy fresh v4.0 with fixes
3. **No State Migration**: Start fresh (no existing mainnet usage)

### For Testing
1. Update test suite to use v4.0 patterns
2. Fix E2E tests with proper timelock handling
3. Add fee structure tests
4. Test partial fills

## Risk Assessment

### High Risk Items
- **Factory Bug**: Production will fail without v2.3 fix
- **Timelock Errors**: All operations fail with current implementation
- **No 1inch Integration**: Cannot work with limit order protocol

### Medium Risk Items
- **Fee Structure**: Missing revenue model
- **Partial Fills**: Limited functionality

### Low Risk Items
- **Event Format**: Only affects indexers
- **Access Control**: Different but functional

## Comparison Table

| Feature | Our Implementation | 1inch Production | Required Change | Priority |
|---------|-------------------|------------------|-----------------|----------|
| Factory Inheritance | IPostInteraction only | SimpleSettlement + Merkle | Add inheritance | CRITICAL |
| postInteraction | public external | internal override | Make internal | CRITICAL |
| Fee Structure | None (empty params) | Full FeeTaker | Implement fees | CRITICAL |
| Partial Fills | Not supported | MerkleStorageInvalidator | Add support | HIGH |
| Timelocks | Incorrect packing | setDeployedAt | Fix packing | CRITICAL |
| Factory Deploy | CREATE3 (broken) | Constructor deploy | Use v2.3 pattern | CRITICAL |
| Extra PostInteraction | Not supported | Chaining support | Add chaining | MEDIUM |
| Access Control | EIP-712 signatures | 1INCH token | Consider change | LOW |
| Timestamp Tolerance | None | 5 minutes | Add tolerance | MEDIUM |
| Events | Custom format | 1inch standard | Align format | LOW |

## Conclusion

Our current implementation has **critical flaws** that prevent it from being 1inch-compatible or even functional in production. The v4.0 proposal addresses these issues with a clear migration path that:

1. **Fixes critical bugs** (factory validation, timelock packing)
2. **Achieves 1inch compatibility** (SimpleSettlement, fee structure)
3. **Maintains simplicity** where possible
4. **Provides upgrade path** for future enhancements

**Recommendation**: Implement Phase 1 immediately (critical fixes), then Phase 2 for full compatibility. Phase 3 can be deferred based on business needs.

## Action Items

1. [ ] Create EscrowFactoryV4 contract with SimpleSettlement inheritance
2. [ ] Fix factory deployment using v2.3 pattern (constructor deploys implementations)
3. [ ] Fix timelock packing in postInteraction
4. [ ] Implement FeeTaker for fee structure
5. [ ] Add MerkleStorageInvalidator for partial fills
6. [ ] Update all tests for v4.0 patterns
7. [ ] Document migration guide
8. [ ] Audit v4.0 implementation
9. [ ] Deploy to testnet for validation
10. [ ] Plan mainnet deployment

## References

- **1inch Production**: `cross-chain-swap/contracts/BaseEscrowFactory.sol`
- **Our Implementation**: `bmn-evm-contracts/contracts/SimplifiedEscrowFactory.sol`
- **Factory Bug Analysis**: `docs/FACTORY_IMMUTABLE_BUG_ANALYSIS.md`
- **Test Failures**: `docs/test/FACTORY_ADDRESS_DISCREPANCY_ANALYSIS.md`
- **1inch Docs**: https://docs.1inch.io/docs/limit-order-protocol/introduction