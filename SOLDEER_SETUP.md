# Soldeer Dependency Management Setup Guide

## Prerequisites

Ensure you have the latest version of Foundry installed:
```bash
foundryup
```

Verify Soldeer is available:
```bash
forge soldeer version
```

## Initial Setup

### 1. Initialize Soldeer in Your Project

```bash
# Navigate to your project root
cd /Users/bioharz/git/2025_2/unite/bridge-me-not/bmn-evm-contracts

# Initialize Soldeer (this will modify foundry.toml)
forge soldeer init --clean
```

The `--clean` flag will help migrate from git submodules to Soldeer dependencies.

### 2. Configure foundry.toml

Update your `foundry.toml` with Soldeer configuration:

```toml
[profile.default]
src = 'contracts'
out = 'out'
libs = ['dependencies']  # Changed from 'lib' to 'dependencies'
test = 'test'
optimizer_runs = 1000000
via-ir = true
evm_version = 'shanghai'
solc_version = '0.8.23'
fs_permissions = [{ access = "read-write", path = "./deployments" }]

[fmt]
line_length = 140
bracket_spacing = true

# Soldeer configuration
[soldeer]
# Generate remappings automatically
remappings_generate = true
# Regenerate all remappings on install/update/uninstall
remappings_regenerate = false
# Add version suffix to remappings (e.g., solmate-v7)
remappings_version = true
# No prefix for remappings
remappings_prefix = ""
# Store remappings in remappings.txt
remappings_location = "txt"

# Dependencies
[dependencies]
# Core dependencies for BMN token project
"@openzeppelin-contracts~5.0.2" = { version = "5.0.2" }
"@solmate~7" = { version = "7" }
"@forge-std~1.9.2" = { version = "1.9.2" }
"@solady~0.0.235" = { version = "0.0.235" }  # For CREATE3
```

### 3. Install Dependencies

```bash
# Install all dependencies defined in foundry.toml
forge soldeer install

# Or install individual dependencies
forge soldeer install @openzeppelin-contracts~5.0.2
forge soldeer install @solmate~7
forge soldeer install @solady~0.0.235
```

### 4. Alternative: Using soldeer.toml

If you prefer a separate configuration file, create `soldeer.toml`:

```toml
# soldeer.toml
[soldeer]
remappings_generate = true
remappings_regenerate = false
remappings_version = true
remappings_prefix = ""

[dependencies]
"@openzeppelin-contracts" = "5.0.2"
"@solmate" = "7"
"@forge-std" = "1.9.2"
"@solady" = "0.0.235"

# Additional dependencies for BMN project
"@1inch-solidity-utils" = "4.2.1"
"@murky" = "1.0.0"
```

## Working with Dependencies

### Installing from Git

For dependencies not in the Soldeer registry:

```bash
# Install from GitHub with specific tag
forge soldeer install limit-order-protocol~3.0.0 \
  --git https://github.com/1inch/limit-order-protocol.git \
  --tag v3.0.0

# Install from GitHub with specific commit
forge soldeer install custom-lib~1.0.0 \
  --git https://github.com/user/repo.git \
  --rev 4695fac44b2934aaa6d7150e2eaf0256fdc566a7
```

### Updating Dependencies

```bash
# Update all dependencies
forge soldeer update

# Update specific dependency
forge soldeer update @openzeppelin-contracts
```

### Uninstalling Dependencies

```bash
forge soldeer uninstall @openzeppelin-contracts
```

## Project Structure with Soldeer

```
bmn-evm-contracts/
├── contracts/
│   ├── BMNAccessTokenV2.sol
│   └── libraries/
├── dependencies/          # Soldeer installs here (not lib/)
│   ├── @openzeppelin-contracts-5.0.2/
│   ├── @solmate-7/
│   ├── @forge-std-1.9.2/
│   └── @solady-0.0.235/
├── test/
├── script/
├── foundry.toml
├── soldeer.lock          # Lock file for reproducible builds
└── remappings.txt        # Auto-generated by Soldeer
```

## Lock File Management

Soldeer creates a `soldeer.lock` file that ensures reproducible builds:

```json
{
  "dependencies": {
    "@openzeppelin-contracts": {
      "version": "5.0.2",
      "source": "registry",
      "checksum": "..."
    },
    "@solmate": {
      "version": "7",
      "source": "registry",
      "checksum": "..."
    }
  }
}
```

**Important**: Commit `soldeer.lock` to version control!

## CI/CD Integration

### GitHub Actions Example

```yaml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        
      - name: Install dependencies
        run: forge soldeer install
        
      - name: Run tests
        run: forge test
```

### Important CI/CD Notes

- Always use `forge soldeer install` in CI, not `forge install`
- The lock file ensures consistent dependency versions
- No need for git submodule commands

## Best Practices

### 1. Version Pinning

Always use exact versions in production:
```toml
[dependencies]
"@openzeppelin-contracts" = "5.0.2"  # Good
"@openzeppelin-contracts" = "^5.0.0" # Avoid in production
```

### 2. Import Patterns

Use version-specific imports for clarity:
```solidity
import "@openzeppelin-contracts-5.0.2/contracts/token/ERC20/ERC20.sol";
import "@solmate-7/utils/CREATE3.sol";
```

### 3. Dependency Updates

- Test thoroughly after updates
- Update one dependency at a time
- Check breaking changes in release notes

### 4. Security Considerations

- Verify checksums in `soldeer.lock`
- Review dependency source code
- Use well-audited versions

## Migration from Git Submodules

### 1. Backup Current Setup
```bash
cp -r lib lib.backup
cp remappings.txt remappings.txt.backup
```

### 2. Remove Git Submodules
```bash
# Remove submodule entries
git rm -r lib/
git rm .gitmodules

# Clean git config
git config --remove-section submodule.lib/forge-std
git config --remove-section submodule.lib/openzeppelin-contracts
# ... repeat for all submodules
```

### 3. Initialize Soldeer
```bash
forge soldeer init --clean
```

### 4. Install Dependencies
```bash
forge soldeer install
```

### 5. Update Imports
Update your Solidity imports to use new paths:
```solidity
// Old
import "openzeppelin-contracts/contracts/token/ERC20/ERC20.sol";

// New
import "@openzeppelin-contracts-5.0.2/contracts/token/ERC20/ERC20.sol";
```

## Troubleshooting

### Common Issues

1. **Dependency conflicts**: Check version constraints
2. **Import errors**: Verify remappings.txt is generated
3. **CI failures**: Ensure `forge soldeer install` runs before tests

### Debug Commands

```bash
# Check installed dependencies
ls -la dependencies/

# Verify remappings
cat remappings.txt

# Force regenerate remappings
forge soldeer install --regenerate-remappings
```

## Example: BMN Token with CREATE3

Here's how to use Solady's CREATE3 with Soldeer:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.23;

import "@openzeppelin-contracts-5.0.2/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin-contracts-5.0.2/contracts/access/Ownable.sol";
import "@solady-0.0.235/utils/CREATE3.sol";

contract BMNTokenFactory {
    using CREATE3 for address;
    
    function deployToken(
        bytes32 salt,
        string memory name,
        string memory symbol
    ) external returns (address) {
        bytes memory creationCode = abi.encodePacked(
            type(BMNToken).creationCode,
            abi.encode(name, symbol, msg.sender)
        );
        
        return CREATE3.deploy(salt, creationCode, 0);
    }
    
    function computeAddress(bytes32 salt) external view returns (address) {
        return CREATE3.predictDeterministicAddress(salt);
    }
}

contract BMNToken is ERC20, Ownable {
    constructor(
        string memory name,
        string memory symbol,
        address owner
    ) ERC20(name, symbol) Ownable(owner) {
        _mint(owner, 1000000 * 10**decimals());
    }
}
```

## Conclusion

Soldeer provides a more robust dependency management solution compared to git submodules, with better version control, automatic remapping generation, and improved CI/CD integration. The lock file ensures reproducible builds across different environments.